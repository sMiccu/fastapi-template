#!/bin/bash
# pre-commit hook - ドキュメント整合性チェック

# このフックはコミット前にドキュメントの整合性をチェックします

# カラー定義
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# 変更されたファイルを取得
STAGED_FILES=$(git diff --cached --name-only)

# チェック関数
check_pyproject_docs() {
    if echo "$STAGED_FILES" | grep -q "pyproject.toml"; then
        # 依存関係が変更されたかチェック
        if git diff --cached pyproject.toml | grep -q "dependencies"; then
            # TECH_STACK.mdも一緒に更新されているかチェック
            if ! echo "$STAGED_FILES" | grep -q "docs/TECH_STACK.md"; then
                echo -e "${YELLOW}⚠️  Warning: pyproject.tomlの依存関係が変更されていますが、${NC}"
                echo "   docs/TECH_STACK.mdは更新されていません。"
                echo ""
                echo "   更新する場合: cursor docs/TECH_STACK.md"
                echo "   スキップする場合: そのままコミット"
                echo ""
            fi
        fi
    fi
}

check_architecture_docs() {
    # アーキテクチャ関連のファイル変更をチェック
    if echo "$STAGED_FILES" | grep -qE "src/app/modules/.*/domain/"; then
        if ! echo "$STAGED_FILES" | grep -qE "docs/(ARCHITECTURE|DOMAIN_MODEL).md"; then
            echo -e "${YELLOW}⚠️  Warning: ドメイン層に変更がありますが、${NC}"
            echo "   ドキュメントは更新されていません。"
            echo ""
            echo "   必要に応じて以下を更新してください:"
            echo "   - docs/ARCHITECTURE.md"
            echo "   - docs/DOMAIN_MODEL.md"
            echo ""
        fi
    fi
}

check_new_module() {
    # 新しいモジュールが追加されたかチェック
    for file in $STAGED_FILES; do
        if [[ $file =~ src/app/modules/([^/]+)/__init__.py ]]; then
            module_name="${BASH_REMATCH[1]}"
            if [ "$module_name" != "catalog" ] && [ "$module_name" != "orders" ]; then
                echo -e "${YELLOW}📦 新しいモジュール '$module_name' が検出されました${NC}"
                echo ""
                echo "   以下のドキュメントを更新してください:"
                echo "   1. docs/DOMAIN_MODEL.md - 新しいBounded Contextの説明"
                echo "   2. docs/ARCHITECTURE.md - 採用したパターンの記載"
                echo "   3. README.md - モジュール一覧への追加"
                echo ""
            fi
        fi
    done
}

check_conventions() {
    # Pythonファイルの型ヒントチェック（簡易）
    for file in $STAGED_FILES; do
        if [[ $file == *.py ]] && [[ $file == src/app/* ]]; then
            # __init__.pyはスキップ
            if [[ $file == */__init__.py ]]; then
                continue
            fi

            # 型ヒントのない関数定義を検出（簡易チェック）
            if git diff --cached "$file" | grep -E "^\+.*def .+\(" | grep -qvE "def .+\(.*\) ->"; then
                echo -e "${YELLOW}⚠️  Warning: $file${NC}"
                echo "   型ヒントがない関数定義が含まれている可能性があります。"
                echo "   docs/CONVENTIONS.md を確認してください。"
                echo ""
            fi
        fi
    done
}

# メイン処理
echo -e "${GREEN}📋 ドキュメント整合性チェック中...${NC}"

check_pyproject_docs
check_architecture_docs
check_new_module
check_conventions

echo -e "${GREEN}✓ チェック完了${NC}"
echo ""

# Warningがあってもコミットは許可（中断しない）
exit 0
